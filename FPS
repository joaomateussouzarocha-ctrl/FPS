-- [[ SERVIÇOS ]] --
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TeleportService = game:GetService("TeleportService")
local Lighting = game:GetService("Lighting")

-- [[ VARIÁVEIS ]] --
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local ESP_Table = {}
local OriginalMapData = {}
local MenuState = {
    ESP = false,
    Aim = false,
    VisibleOnly = false,
    FOVEnabled = false,
    FPSMode = false,
    FOVSize = 100
}

-- [[ GUI PRINCIPAL ]] --
local ScreenGui = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
ScreenGui.Name = "XJ_Fixed_System"
ScreenGui.ResetOnSpawn = false

-- Função Arrastar
local function MakeDraggable(frame)
    local dragging, dragInput, dragStart, startPos
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging, dragStart, startPos = true, input.Position, frame.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

-- [[ TELA DE LOGIN CORRIGIDA ]] --
local LoginFrame = Instance.new("Frame", ScreenGui)
LoginFrame.Size = UDim2.new(0, 260, 0, 220)
LoginFrame.Position = UDim2.new(0.5, -130, 0.3, 0)
LoginFrame.BackgroundColor3 = Color3.new(0, 0, 0)
LoginFrame.BackgroundTransparency = 0.2
Instance.new("UICorner", LoginFrame).CornerRadius = UDim.new(0, 20)
local LoginStroke = Instance.new("UIStroke", LoginFrame)
LoginStroke.Color, LoginStroke.Thickness, LoginStroke.Transparency = Color3.new(0.5, 0.5, 0.5), 10, 0.5
MakeDraggable(LoginFrame)

local StatusLabel = Instance.new("TextLabel", LoginFrame)
StatusLabel.Size = UDim2.new(1, 0, 0.3, 0)
StatusLabel.Position = UDim2.new(0, 0, 0.1, 0)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Loading System..."
StatusLabel.TextColor3 = Color3.new(1, 1, 1)
StatusLabel.Font = Enum.Font.GothamBold
StatusLabel.TextSize = 18

local BarContainer = Instance.new("Frame", LoginFrame)
BarContainer.Size = UDim2.new(0, 180, 0, 8)
BarContainer.Position = UDim2.new(0.5, -90, 0.45, 0)
BarContainer.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
Instance.new("UICorner", BarContainer)

local ProgressBar = Instance.new("Frame", BarContainer)
ProgressBar.Size = UDim2.new(0, 0, 1, 0)
ProgressBar.BackgroundColor3 = Color3.new(1, 1, 1)
Instance.new("UICorner", ProgressBar)

task.spawn(function()
    ProgressBar:TweenSize(UDim2.new(1, 0, 1, 0), "Out", "Linear", 2)
    task.wait(2.2)
    StatusLabel.Text = "Enter Password"
    BarContainer:Destroy()
    
    local PassInput = Instance.new("TextBox", LoginFrame)
    PassInput.Size = UDim2.new(0.8, 0, 0.2, 0)
    PassInput.Position = UDim2.new(0.1, 0, 0.55, 0)
    PassInput.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
    PassInput.Text = ""
    PassInput.PlaceholderText = "Password Here"
    PassInput.TextColor3 = Color3.new(1, 1, 1)
    PassInput.Font = Enum.Font.GothamBold
    PassInput.TextSize = 14
    Instance.new("UICorner", PassInput)
    
    PassInput.FocusLost:Connect(function(enter)
        if enter then
            if PassInput.Text == "xjscripts" then
                StatusLabel.Text = "Access Granted"
                task.wait(0.5)
                LoginFrame:Destroy()
                InitCheat()
            else
                StatusLabel.Text = "Wrong Password"
                task.wait(1)
                StatusLabel.Text = "Enter Password"
                PassInput.Text = ""
            end
        end
    end)
end)

-- [[ SISTEMA PRINCIPAL ]] --
function InitCheat()
    local MainFrame = Instance.new("Frame", ScreenGui)
    MainFrame.Size = UDim2.new(0, 380, 0, 280)
    MainFrame.Position = UDim2.new(0.5, -190, 0.2, 0)
    MainFrame.BackgroundColor3 = Color3.new(0, 0, 0)
    MainFrame.BackgroundTransparency = 0.2
    Instance.new("UICorner", MainFrame)
    local MainStroke = Instance.new("UIStroke", MainFrame)
    MainStroke.Color, MainStroke.Thickness = Color3.new(0.5, 0.5, 0.5), 4
    MakeDraggable(MainFrame)

    -- Sidebar
    local Sidebar = Instance.new("Frame", MainFrame)
    Sidebar.Size = UDim2.new(0, 100, 1, 0)
    Sidebar.BackgroundColor3 = Color3.new(0.05, 0.05, 0.05)
    Instance.new("UICorner", Sidebar)

    local Content = Instance.new("Frame", MainFrame)
    Content.Size = UDim2.new(1, -110, 1, -20)
    Content.Position = UDim2.new(0, 105, 0, 10)
    Content.BackgroundTransparency = 1

    local Tabs = {}
    local function NewTab(name, id)
        local frame = Instance.new("ScrollingFrame", Content)
        frame.Size = UDim2.new(1, 0, 1, 0)
        frame.BackgroundTransparency = 1
        frame.Visible = false
        frame.CanvasSize = UDim2.new(0, 0, 1.2, 0)
        frame.ScrollBarThickness = 2
        Tabs[id] = frame

        local btn = Instance.new("TextButton", Sidebar)
        btn.Size = UDim2.new(1, -10, 0, 40)
        btn.Position = UDim2.new(0, 5, 0, 10 + (id-1)*45)
        btn.Text = name
        btn.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
        btn.TextColor3 = Color3.new(1, 1, 1)
        btn.Font = Enum.Font.GothamBold
        btn.TextSize = 12
        Instance.new("UICorner", btn)

        btn.MouseButton1Click:Connect(function()
            for _, v in pairs(Tabs) do v.Visible = false end
            for _, v in pairs(Sidebar:GetChildren()) do if v:IsA("TextButton") then v.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1) end end
            frame.Visible = true
            btn.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
        end)
        return frame
    end

    local VisualsTab = NewTab("VISUALS", 1)
    local CombatTab = NewTab("COMBAT", 2)
    local MiscTab = NewTab("MISC", 3)

    -- Helper para botões
    local function AddToggle(txt, y, parent, callback)
        local btn = Instance.new("TextButton", parent)
        btn.Size = UDim2.new(1, -10, 0, 35)
        btn.Position = UDim2.new(0, 5, 0, y)
        btn.Text = txt .. ": OFF"
        btn.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
        btn.TextColor3 = Color3.new(1, 1, 1)
        btn.Font = Enum.Font.GothamBold
        btn.TextSize = 12
        Instance.new("UICorner", btn)

        local active = false
        btn.MouseButton1Click:Connect(function()
            active = not active
            btn.Text = txt .. ": " .. (active and "ON" or "OFF")
            btn.BackgroundColor3 = active and Color3.new(1, 1, 1) or Color3.new(0.1, 0.1, 0.1)
            btn.TextColor3 = active and Color3.new(0, 0, 0) or Color3.new(1, 1, 1)
            callback(active)
        end)
    end

    -- [ ABA VISUALS ] --
    AddToggle("ESP BOX", 0, VisualsTab, function(v) MenuState.ESP = v end)

    -- [ ABA COMBAT ] --
    AddToggle("AIMBOT", 0, CombatTab, function(v) MenuState.Aim = v end)
    AddToggle("ONLY VISIBLE", 40, CombatTab, function(v) MenuState.VisibleOnly = v end)
    AddToggle("SHOW FOV", 80, CombatTab, function(v) 
        MenuState.FOVEnabled = v 
        ScreenGui.FOV_Circle.Visible = v 
    end)
    
    local fovBox = Instance.new("TextBox", CombatTab)
    fovBox.Size, fovBox.Position = UDim2.new(1, -10, 0, 35), UDim2.new(0, 5, 0, 120)
    fovBox.Text, fovBox.PlaceholderText = "100", "FOV Size"
    fovBox.BackgroundColor3, fovBox.TextColor3 = Color3.new(0.1, 0.1, 0.1), Color3.new(1, 1, 1)
    fovBox.Font, fovBox.TextSize = Enum.Font.GothamBold, 12
    Instance.new("UICorner", fovBox)
    fovBox:GetPropertyChangedSignal("Text"):Connect(function()
        local n = tonumber(fovBox.Text) or 0
        MenuState.FOVSize = n
        ScreenGui.FOV_Circle.Size = UDim2.new(0, n*2, 0, n*2)
    end)

    -- [ ABA MISC ] --
    AddToggle("FPS BOOST", 0, MiscTab, function(v)
        MenuState.FPSMode = v
        if v then
            OriginalMapData.Ambient = Lighting.OutdoorAmbient
            Lighting.OutdoorAmbient = Color3.new(1, 1, 1)
            for _, x in pairs(Lighting:GetChildren()) do if x:IsA("Sky") or x:IsA("Atmosphere") then x:Destroy() end end
            local s = Instance.new("Sky", Lighting)
            local id = "rbxassetid://6039289839"
            s.SkyboxBk, s.SkyboxDn, s.SkyboxFt, s.SkyboxLf, s.SkyboxRt, s.SkyboxUp = id, id, id, id, id, id
            for _, p in pairs(workspace:GetDescendants()) do
                if p:IsA("BasePart") and not p:IsDescendantOf(LocalPlayer.Character) then
                    OriginalMapData[p] = {p.Color, p.Material}
                    p.Color, p.Material = Color3.fromRGB(35,35,35), Enum.Material.SmoothPlastic
                end
            end
        else
            if OriginalMapData.Ambient then Lighting.OutdoorAmbient = OriginalMapData.Ambient end
            for p, d in pairs(OriginalMapData) do if p ~= "Ambient" and p.Parent then p.Color, p.Material = d[1], d[2] end end
            OriginalMapData = {}
        end
    end)

    local btnRejoin = Instance.new("TextButton", MiscTab)
    btnRejoin.Size, btnRejoin.Position = UDim2.new(1, -10, 0, 35), UDim2.new(0, 5, 0, 45)
    btnRejoin.Text, btnRejoin.BackgroundColor3 = "REJOIN GAME", Color3.fromRGB(80, 20, 20)
    btnRejoin.TextColor3, btnRejoin.Font, btnRejoin.TextSize = Color3.new(1,1,1), Enum.Font.GothamBold, 12
    Instance.new("UICorner", btnRejoin)
    btnRejoin.MouseButton1Click:Connect(function() TeleportService:Teleport(game.PlaceId, LocalPlayer) end)

    -- FOV Visual
    local fovC = Instance.new("Frame", ScreenGui)
    fovC.Name, fovC.AnchorPoint, fovC.Position = "FOV_Circle", Vector2.new(0.5, 0.5), UDim2.new(0.5, 0, 0.5, 0)
    fovC.BackgroundTransparency, fv.Visible = 1, false
    local fovSt = Instance.new("UIStroke", fovC)
    fovSt.Color, fovSt.Thickness = Color3.new(1, 1, 1), 1
    Instance.new("UICorner", fovC).CornerRadius = UDim.new(1, 0)

    -- Botão Minimizar (Círculo Branco, Borda Preta)
    local MinBtn = Instance.new("TextButton", ScreenGui)
    MinBtn.Size = UDim2.new(0, 45, 0, 45)
    MinBtn.Position = UDim2.new(0.5, -22, 0.05, 0)
    MinBtn.BackgroundColor3 = Color3.new(1, 1, 1)
    MinBtn.Text, MinBtn.TextColor3 = "XJ", Color3.new(0, 0, 0)
    MinBtn.Font, MinBtn.TextSize, MinBtn.Visible = Enum.Font.GothamBold, 14, false
    Instance.new("UICorner", MinBtn).CornerRadius = UDim.new(1, 0)
    local MinStroke = Instance.new("UIStroke", MinBtn)
    MinStroke.Color, MinStroke.Thickness = Color3.new(0, 0, 0), 2
    MakeDraggable(MinBtn)

    local function ToggleMenu()
        MainFrame.Visible = not MainFrame.Visible
        MinBtn.Visible = not MainFrame.Visible
    end
    MinBtn.MouseButton1Click:Connect(ToggleMenu)
    UserInputService.InputBegan:Connect(function(i, g) if not g and i.KeyCode == Enum.KeyCode.RightControl then ToggleMenu() end end)
    
    VisualsTab.Visible = true -- Começa na primeira aba

    -- [[ LOOPS ]] --
    RunService.RenderStepped:Connect(function()
        local target, dist = nil, 9e9
        local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)

        for _, plr in pairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                local hrp = plr.Character.HumanoidRootPart
                
                -- ESP
                if MenuState.ESP then
                    if not ESP_Table[plr] or not ESP_Table[plr].Parent then
                        local bb = Instance.new("BillboardGui", ScreenGui)
                        bb.AlwaysOnTop, bb.Size, bb.Adornee = true, UDim2.new(4, 0, 5, 0), hrp
                        local f = Instance.new("Frame", bb)
                        f.Size, f.BackgroundColor3, f.BackgroundTransparency = UDim2.new(1, 0, 1, 0), Color3.new(1, 0, 0), 0.7
                        Instance.new("UIStroke", f).Thickness = 1.5
                        ESP_Table[plr] = bb
                    end
                    ESP_Table[plr].Enabled = true
                elseif ESP_Table[plr] then
                    ESP_Table[plr].Enabled = false
                end

                -- AIMBOT
                if MenuState.Aim then
                    local pos, s = Camera:WorldToViewportPoint(hrp.Position)
                    if s then
                        local mag = (center - Vector2.new(pos.X, pos.Y)).Magnitude
                        if (not MenuState.FOVEnabled or mag < MenuState.FOVSize) and mag < dist then
                            local visible = true
                            if MenuState.VisibleOnly then
                                local obs = Camera:GetPartsObscuringTarget({hrp.Position}, {LocalPlayer.Character, plr.Character})
                                if #obs > 0 then visible = false end
                            end
                            if visible then dist, target = mag, hrp end
                        end
                    end
                end
            end
        end
        if target then Camera.CFrame = Camera.CFrame:Lerp(CFrame.new(Camera.CFrame.Position, target.Position), 0.15) end
    end)
end
